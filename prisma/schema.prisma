generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  displayName String
  description String?
  isActive    Boolean          @default(true)
  isDefault   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]

  @@index([name])
  @@index([isActive])
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  displayName String
  description String?
  category    String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@index([name])
  @@index([category])
  @@index([isActive])
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model User {
  id                       String           @id @default(uuid())
  email                    String           @unique
  clerkId                  String           @unique
  firstName                String?
  lastName                 String?
  avatar                   String?
  bio                      String?
  phone                    String?
  department               String?
  joinDate                 String?
  status                   String?          @default("Hoạt động")
  experienceLevel          ExperienceLevel? @default(mid)
  roleId                   String           @default("user_role_id")
  skills                   String[]
  lastLogin                DateTime?
  lastSignInAt             DateTime?
  lastActivity             DateTime?
  isOnline                 Boolean          @default(false)
  clerkSessionActive       Boolean          @default(false)
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  preferredJobRoleId       String?
  preferredLanguage        String?          @default("vi")
  interviewPreferences     Json?
  autoStartWithPreferences Boolean          @default(true)
  interviews               Interview[]
  paymentHistory           PaymentHistory[]
  
  preferredJobRole         JobRole?         @relation("UserPreferredJobRole", fields: [preferredJobRoleId], references: [id])
  role                     Role             @relation(fields: [roleId], references: [id])
  userPackages             UserPackage[]
  
  activityEvents           UserActivityEvent[]
  dailyStats               UserDailyStats[]
  skillSnapshots           UserSkillSnapshot[]
  questionItemsCreated     QuestionItem[]     @relation("QuestionItemsCreated")
  questionSetsCreated      QuestionSet[]      @relation("QuestionSetsCreated")
  quizTemplatesCreated     QuizTemplate[]     @relation("QuizTemplatesCreated")
  savedQuestionItems       QuestionItem[]     @relation("SavedQuestionItems")
  quizAttempts             QuizAttempt[]

  @@index([roleId])
}

model Interview {
  id                  String          @id @default(uuid())
  userId              String
  jobRoleId           String
  language            String
  startTime           DateTime
  endTime             DateTime?
  duration            Int?
  conversationHistory Json
  evaluation          Json
  questionCount       Int             @default(0)
  coveredTopics       String[]
  skillAssessment     Json
  progress            Int             @default(0)
  status              InterviewStatus @default(in_progress)
  jobRole             JobRole         @relation(fields: [jobRoleId], references: [id])
  user                User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([jobRoleId])
}

// Legacy Quiz model removed after migration to new quiz flow
// New Question Bank models (next-gen)

model QuestionItem {
  id           String              @id @default(uuid())
  type         QuestionItemType
  stem         String
  explanation  String?
  level        QuizLevel?
  topics       String[]
  fields       String[]
  skills       String[]
  difficulty   Float?
  createdById  String?
  createdBy    User?               @relation("QuestionItemsCreated", fields: [createdById], references: [id])
  options      QuestionOption[]
  usersSaved   User[]              @relation("SavedQuestionItems")
  setLinks     QuestionSetQuestion[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
}

model QuestionOption {
  id          String       @id @default(uuid())
  questionId  String
  text        String
  isCorrect   Boolean      @default(false)
  order       Int          @default(0)
  metadata    Json?
  question    QuestionItem @relation(fields: [questionId], references: [id])
}

model QuestionSet {
  id           String        @id @default(uuid())
  name         String
  description  String?
  companyId    String?
  jobRoleId    String?
  level        QuizLevel?
  topics       String[]
  fields       String[]
  version      Int           @default(1)
  status       String        @default("draft")
  createdById  String?
  createdBy    User?         @relation("QuestionSetsCreated", fields: [createdById], references: [id])
  jobRole      JobRole?      @relation(fields: [jobRoleId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  items        QuestionSetQuestion[]
  templates    QuizTemplate[]

  @@index([jobRoleId])
}

model QuestionSetQuestion {
  id             String       @id @default(uuid())
  questionSetId  String
  questionId     String
  order          Int          @default(0)
  section        String?
  weight         Float        @default(1)
  isRequired     Boolean      @default(true)
  timeSuggestion Int?
  questionSet    QuestionSet  @relation(fields: [questionSetId], references: [id])
  question       QuestionItem @relation(fields: [questionId], references: [id])

  @@unique([questionSetId, questionId])
  @@index([questionSetId])
  @@index([questionId])
}

model QuizTemplate {
  id            String       @id @default(uuid())
  questionSetId String
  name          String
  description   String?
  timeLimit     Int?
  shuffle       Boolean      @default(true)
  sectionRules  Json?
  scoringPolicy Json?
  retakePolicy  Json?
  isActive      Boolean      @default(true)
  createdById   String?
  createdBy     User?        @relation("QuizTemplatesCreated", fields: [createdById], references: [id])
  questionSet   QuestionSet  @relation(fields: [questionSetId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  attempts      QuizAttempt[]

  @@index([questionSetId])
}

model QuizAttempt {
  id            String        @id @default(uuid())
  templateId    String
  userId        String
  status        String        @default("in_progress")
  startedAt     DateTime      @default(now())
  completedAt   DateTime?
  timeUsed      Int?
  score         Float?
  sectionScores Json?
  itemsSnapshot Json
  responses     Json?
  template      QuizTemplate  @relation(fields: [templateId], references: [id])
  user          User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([templateId])
}

model JdQuestions {
  id             String          @id @default(uuid())
  userId         String
  jobTitle       String
  questionType   QuestionType
  level          ExperienceLevel
  questions      String[]
  originalJDText String?
  fileName       String?
  createdAt      DateTime?       @default(now())
  updatedAt      DateTime?       @updatedAt
  jdAnswers      JdAnswers[]
}

model JdAnswers {
  id              String      @id @default(uuid())
  userId          String
  jdQuestionSetId String
  questionIndex   Int
  questionText    String
  userAnswer      String
  feedback        String?
  scores          Json?
  overallScore    Float?
  strengths       String[]
  improvements    String[]
  skillAssessment Json?
  timeSpent       Int?
  answeredAt      DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  jdQuestionSet   JdQuestions @relation(fields: [jdQuestionSetId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jdQuestionSetId])
  @@index([answeredAt])
}

model Assessment {
  id               String           @id @default(uuid())
  userId           String
  type             AssessmentType
  jobRoleId        String?
  selectedCategory String?
  level            String
  duration         Int
  totalTime        Int
  history          Json?
  realTimeScores   Json?
  finalScores      Json?
  status           AssessmentStatus @default(in_progress)
  overallFeedback  String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime?        @updatedAt
  jobRole          JobRole?         @relation(fields: [jobRoleId], references: [id])

  @@index([jobRoleId])
}

model ServicePackage {
  id                   String           @id @default(uuid())
  name                 String
  price                Int
  duration             Int
  avatarInterviewLimit Int              @default(0)
  testQuizEQLimit      Int              @default(0)
  jdUploadLimit        Int              @default(0)
  description          String?
  highlight            Boolean          @default(false)
  createdAt            DateTime         @default(now())
  isActive             Boolean          @default(true)
  updatedAt            DateTime         @updatedAt
  paymentHistory       PaymentHistory[]
  userPackages         UserPackage[]

  @@index([name])
  @@index([price])
}

model UserPackage {
  id                  String         @id @default(uuid())
  userId              String
  servicePackageId    String
  orderCode           String?        @unique
  startDate           DateTime       @default(now())
  endDate             DateTime
  avatarInterviewUsed Int            @default(0)
  testQuizEQUsed      Int            @default(0)
  jdUploadUsed        Int            @default(0)
  isActive            Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  servicePackage      ServicePackage @relation(fields: [servicePackageId], references: [id])
  user                User           @relation(fields: [userId], references: [id])

  @@unique([userId, servicePackageId])
  @@index([userId])
  @@index([servicePackageId])
  @@index([isActive])
}

model PaymentHistory {
  id               String         @id @default(uuid())
  userId           String
  servicePackageId String
  orderCode        String         @unique
  amount           Int
  refundAmount     Int            @default(0)
  description      String
  status           PaymentStatus  @default(pending)
  paymentMethod    String?
  transactionId    String?
  checkoutUrl      String?
  qrCode           String?
  returnUrl        String?
  cancelUrl        String?
  paidAt           DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  servicePackage   ServicePackage @relation(fields: [servicePackageId], references: [id])
  user             User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([servicePackageId])
  @@index([status])
  @@index([orderCode])
}

/// New event-based tracking models (backward compatible with existing UserActivity)
model UserActivityEvent {
  id            String        @id @default(uuid())
  userId        String
  activityType  ActivityType
  feature       String?
  action        String        // e.g., started, completed, resumed
  score         Float?
  duration      Int?
  referenceId   String?
  timestamp     DateTime      @default(now())
  metadata      Json?
  skillDeltas   Json?
  user          User          @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
  @@index([activityType, timestamp])
  @@index([referenceId])
}

model UserDailyStats {
  id                   String   @id @default(uuid())
  userId               String
  date                 DateTime
  totalActivities      Int      @default(0)
  totalDuration        Int      @default(0)
  avgScore             Float?
  activityTypeBreakdown Json?
  skillAverages        Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId, date])
}

model UserSkillSnapshot {
  id          String        @id @default(uuid())
  userId      String
  skillName   String
  score       Float
  source      ActivityType?
  referenceId String?
  createdAt   DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId, skillName, createdAt])
}

model JobCategory {
  id              String              @id @default(uuid())
  name            String              @unique
  skills          String[]            // Array of skills like ["React", "Vite", "TypeScript"]
  jobRoles        JobRole[]
  specializations JobSpecialization[]
}

model JobSpecialization {
  id         String      @id @default(uuid())
  name       String      @unique
  categoryId String
  jobRoles   JobRole[]
  category   JobCategory @relation(fields: [categoryId], references: [id])
}

model JobRole {
  id               String             @id @default(uuid())
  key              String             @unique
  title            String
  level            JobLevel
  description      String?
  minExperience    Int                @default(0)
  maxExperience    Int?
  order            Int                @default(0)
  categoryId       String?
  specializationId String?
  assessments      Assessment[]
  interviews       Interview[]
  category         JobCategory?       @relation(fields: [categoryId], references: [id])
  specialization   JobSpecialization? @relation(fields: [specializationId], references: [id])
  usersPreferred   User[]             @relation("UserPreferredJobRole")
  questionSets     QuestionSet[]

  @@index([title])
  @@index([level])
  @@index([categoryId])
  @@index([specializationId])
}

enum ExperienceLevel {
  junior
  mid
  senior
}

enum InterviewStatus {
  completed
  interrupted
  in_progress
}

enum InterviewMessageRole {
  user
  ai
  system
}

enum HiringRecommendation {
  strong_hire
  hire
  consider
  reject
}

enum QuizLevel {
  junior
  middle
  senior
}

enum QuestionType {
  technical
  behavioral
}

// New enum for QuestionItem type (distinct from existing QuestionType)
enum QuestionItemType {
  single_choice
  multiple_choice
  free_text
  scale
  coding
}

enum GoalStatus {
  pending
  in_progress
  completed
}

enum GoalType {
  skill
  interview
  certification
}

enum SkillLevel {
  beginner
  intermediate
  advanced
  expert
}

enum ActivityType {
  interview
  quiz
  practice
  learning
  goal_completed
  goal_started
  jd
}

enum AssessmentType {
  test
  eq
}

enum PaymentStatus {
  pending
  success
  failed
  cancelled
}

enum AssessmentStatus {
  in_progress
  completed
}

enum JobLevel {
  Intern
  Junior
  Mid
  Senior
  Lead
}

